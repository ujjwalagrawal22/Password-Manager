(function(){"use strict";var X={exports:{}};(function(s,x){(function(y){function p(t){const e=new Uint32Array([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]);let n=1779033703,i=3144134277,o=1013904242,c=2773480762,r=1359893119,u=2600822924,w=528734635,l=1541459225;const L=new Uint32Array(64);function S(P){let k=0,O=P.length;for(;O>=64;){let U=n,j=i,M=o,V=c,a=r,T=u,d=w,G=l,v,g,H,J,N;for(g=0;g<16;g++)H=k+g*4,L[g]=(P[H]&255)<<24|(P[H+1]&255)<<16|(P[H+2]&255)<<8|P[H+3]&255;for(g=16;g<64;g++)v=L[g-2],J=(v>>>17|v<<15)^(v>>>19|v<<13)^v>>>10,v=L[g-15],N=(v>>>7|v<<25)^(v>>>18|v<<14)^v>>>3,L[g]=(J+L[g-7]|0)+(N+L[g-16]|0)|0;for(g=0;g<64;g++)J=(((a>>>6|a<<26)^(a>>>11|a<<21)^(a>>>25|a<<7))+(a&T^~a&d)|0)+(G+(e[g]+L[g]|0)|0)|0,N=((U>>>2|U<<30)^(U>>>13|U<<19)^(U>>>22|U<<10))+(U&j^U&M^j&M)|0,G=d,d=T,T=a,a=V+J|0,V=M,M=j,j=U,U=J+N|0;n=n+U|0,i=i+j|0,o=o+M|0,c=c+V|0,r=r+a|0,u=u+T|0,w=w+d|0,l=l+G|0,k+=64,O-=64}}S(t);let R,B=t.length%64,C=t.length/536870912|0,I=t.length<<3,$=B<56?56:120,E=t.slice(t.length-B,t.length);for(E.push(128),R=B+1;R<$;R++)E.push(0);return E.push(C>>>24&255),E.push(C>>>16&255),E.push(C>>>8&255),E.push(C>>>0&255),E.push(I>>>24&255),E.push(I>>>16&255),E.push(I>>>8&255),E.push(I>>>0&255),S(E),[n>>>24&255,n>>>16&255,n>>>8&255,n>>>0&255,i>>>24&255,i>>>16&255,i>>>8&255,i>>>0&255,o>>>24&255,o>>>16&255,o>>>8&255,o>>>0&255,c>>>24&255,c>>>16&255,c>>>8&255,c>>>0&255,r>>>24&255,r>>>16&255,r>>>8&255,r>>>0&255,u>>>24&255,u>>>16&255,u>>>8&255,u>>>0&255,w>>>24&255,w>>>16&255,w>>>8&255,w>>>0&255,l>>>24&255,l>>>16&255,l>>>8&255,l>>>0&255]}function A(t,e,n){t=t.length<=64?t:p(t);const i=64+e.length+4,o=new Array(i),c=new Array(64);let r,u=[];for(r=0;r<64;r++)o[r]=54;for(r=0;r<t.length;r++)o[r]^=t[r];for(r=0;r<e.length;r++)o[64+r]=e[r];for(r=i-4;r<i;r++)o[r]=0;for(r=0;r<64;r++)c[r]=92;for(r=0;r<t.length;r++)c[r]^=t[r];function w(){for(let l=i-1;l>=i-4;l--){if(o[l]++,o[l]<=255)return;o[l]=0}}for(;n>=32;)w(),u=u.concat(p(c.concat(p(o)))),n-=32;return n>0&&(w(),u=u.concat(p(c.concat(p(o))).slice(0,n))),u}function K(t,e,n,i,o){let c;for(m(t,(2*n-1)*16,o,0,16),c=0;c<2*n;c++)_(t,c*16,o,16),D(o,i),m(o,0,t,e+c*16,16);for(c=0;c<n;c++)m(t,e+c*2*16,t,c*16,16);for(c=0;c<n;c++)m(t,e+(c*2+1)*16,t,(c+n)*16,16)}function f(t,e){return t<<e|t>>>32-e}function D(t,e){m(t,0,e,0,16);for(let n=8;n>0;n-=2)e[4]^=f(e[0]+e[12],7),e[8]^=f(e[4]+e[0],9),e[12]^=f(e[8]+e[4],13),e[0]^=f(e[12]+e[8],18),e[9]^=f(e[5]+e[1],7),e[13]^=f(e[9]+e[5],9),e[1]^=f(e[13]+e[9],13),e[5]^=f(e[1]+e[13],18),e[14]^=f(e[10]+e[6],7),e[2]^=f(e[14]+e[10],9),e[6]^=f(e[2]+e[14],13),e[10]^=f(e[6]+e[2],18),e[3]^=f(e[15]+e[11],7),e[7]^=f(e[3]+e[15],9),e[11]^=f(e[7]+e[3],13),e[15]^=f(e[11]+e[7],18),e[1]^=f(e[0]+e[3],7),e[2]^=f(e[1]+e[0],9),e[3]^=f(e[2]+e[1],13),e[0]^=f(e[3]+e[2],18),e[6]^=f(e[5]+e[4],7),e[7]^=f(e[6]+e[5],9),e[4]^=f(e[7]+e[6],13),e[5]^=f(e[4]+e[7],18),e[11]^=f(e[10]+e[9],7),e[8]^=f(e[11]+e[10],9),e[9]^=f(e[8]+e[11],13),e[10]^=f(e[9]+e[8],18),e[12]^=f(e[15]+e[14],7),e[13]^=f(e[12]+e[15],9),e[14]^=f(e[13]+e[12],13),e[15]^=f(e[14]+e[13],18);for(let n=0;n<16;++n)t[n]+=e[n]}function _(t,e,n,i){for(let o=0;o<i;o++)n[o]^=t[e+o]}function m(t,e,n,i,o){for(;o--;)n[i++]=t[e++]}function Q(t){if(!t||typeof t.length!="number")return!1;for(let e=0;e<t.length;e++){const n=t[e];if(typeof n!="number"||n%1||n<0||n>=256)return!1}return!0}function z(t,e){if(typeof t!="number"||t%1)throw new Error("invalid "+e);return t}function Y(t,e,n,i,o,c,r){if(n=z(n,"N"),i=z(i,"r"),o=z(o,"p"),c=z(c,"dkLen"),n===0||n&n-1)throw new Error("N must be power of 2");if(n>2147483647/128/i)throw new Error("N too large");if(i>2147483647/128/o)throw new Error("r too large");if(!Q(t))throw new Error("password must be an array or buffer");if(t=Array.prototype.slice.call(t),!Q(e))throw new Error("salt must be an array or buffer");e=Array.prototype.slice.call(e);let u=A(t,e,o*128*i);const w=new Uint32Array(o*32*i);for(let a=0;a<w.length;a++){const T=a*4;w[a]=(u[T+3]&255)<<24|(u[T+2]&255)<<16|(u[T+1]&255)<<8|(u[T+0]&255)<<0}const l=new Uint32Array(64*i),L=new Uint32Array(32*i*n),S=32*i,R=new Uint32Array(16),B=new Uint32Array(16),C=o*n*2;let I=0,$=null,E=!1,P=0,k=0,O,U;const j=r?parseInt(1e3/i):4294967295,M=typeof setImmediate<"u"?setImmediate:setTimeout,V=function(){if(E)return r(new Error("cancelled"),I/C);let a;switch(P){case 0:U=k*32*i,m(w,U,l,0,S),P=1,O=0;case 1:a=n-O,a>j&&(a=j);for(let d=0;d<a;d++)m(l,0,L,(O+d)*S,S),K(l,S,i,R,B);if(O+=a,I+=a,r){const d=parseInt(1e3*I/C);if(d!==$){if(E=r(null,I/C),E)break;$=d}}if(O<n)break;O=0,P=2;case 2:a=n-O,a>j&&(a=j);for(let d=0;d<a;d++){const G=(2*i-1)*16,v=l[G]&n-1;_(L,v*S,l,S),K(l,S,i,R,B)}if(O+=a,I+=a,r){const d=parseInt(1e3*I/C);if(d!==$){if(E=r(null,I/C),E)break;$=d}}if(O<n)break;if(m(l,0,w,U,S),k++,k<o){P=0;break}u=[];for(let d=0;d<w.length;d++)u.push(w[d]>>0&255),u.push(w[d]>>8&255),u.push(w[d]>>16&255),u.push(w[d]>>24&255);const T=A(t,u,c);return r&&r(null,1,T),T}r&&M(V)};if(!r)for(;;){const a=V();if(a!=null)return a}V()}const fe={scrypt:function(t,e,n,i,o,c,r){return new Promise(function(u,w){let l=0;r&&r(0),Y(t,e,n,i,o,c,function(L,S,R){if(L)w(L);else if(R)r&&l!==1&&r(1),u(new Uint8Array(R));else if(r&&S!==l)return l=S,r(S)})})},syncScrypt:function(t,e,n,i,o,c){return new Uint8Array(Y(t,e,n,i,o,c))}};s.exports=fe})()})(X);var ee=X.exports;function W(s){if(s.length%2!==0)throw new Error("Invalid hex string");const x=new Uint8Array(s.length/2);for(let y=0;y<x.length;y++)x[y]=parseInt(s.substr(y*2,2),16);return x}function q(s){return Array.from(s).map(x=>x.toString(16).padStart(2,"0")).join("")}async function te(s,x,y){const h=y.cost,p=y.blockSize,A=y.parallelization,K=32,f=new TextEncoder().encode(s),D=W(x),_=await ee.scrypt(f,D,h,p,A,K);return new Uint8Array(_)}async function ne(s,x){const y=crypto.getRandomValues(new Uint8Array(16)),h=await crypto.subtle.importKey("raw",x,{name:"AES-CBC"},!1,["encrypt"]),p=await crypto.subtle.encrypt({name:"AES-CBC",iv:y},h,new TextEncoder().encode(s));return{encryptedData:q(new Uint8Array(p)),iv:q(y)}}async function re(s,x,y){const h=W(s),p=W(x),A=await crypto.subtle.importKey("raw",y,{name:"AES-CBC"},!1,["decrypt"]),K=await crypto.subtle.decrypt({name:"AES-CBC",iv:p},A,h);return new TextDecoder().decode(K)}const F="http://localhost:3001/api";let b={token:null,derivedKey:null,isLoggedIn:!1};async function Z(s,x={}){if(!b.token)throw new Error("Not authenticated");const y={"Content-Type":"application/json",Authorization:`Bearer ${b.token}`,...x.headers},h=await fetch(s,{...x,headers:y});if(h.status===401)throw b.token=null,b.derivedKey=null,b.isLoggedIn=!1,new Error("Authentication failed. Please log in again.");if(!h.ok){const A=await h.json();throw new Error(A.error||`API request failed with status ${h.status}`)}const p=h.headers.get("content-type");return p&&p.indexOf("application/json")!==-1?h.json():null}chrome.runtime.onMessage.addListener((s,x,y)=>((async()=>{try{if(s.type==="LOGIN"){const{email:h,masterPassword:p}=s.data,A=await fetch(`${F}/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:h,masterPassword:p})});if(!A.ok){const m=await A.json();throw new Error(m.error)}const{token:K,salt:f,kdfParams:D}=await A.json(),_=await te(p,f,D);b.token=K,b.derivedKey=_,b.isLoggedIn=!0,console.log("Login successful. Key derived and stored in memory."),y({success:!0})}else if(s.type==="LOGOUT")b.token=null,b.derivedKey=null,b.isLoggedIn=!1,console.log("User logged out."),y({success:!0});else if(s.type==="GET_LOGIN_STATUS")y({isLoggedIn:b.isLoggedIn});else if(s.type==="PASSWORD_CAPTURED"){if(!b.isLoggedIn)return;chrome.tabs.sendMessage(x.tab.id,{type:"PROMPT_TO_SAVE_PASSWORD",data:s.data})}else if(s.type==="SAVE_CREDENTIALS"){if(!b.derivedKey)throw new Error("Cannot save. User is not logged in or key is missing.");const h=JSON.stringify(s.data),{encryptedData:p,iv:A}=await ne(h,b.derivedKey);await Z(`${F}/passwords`,{method:"POST",body:JSON.stringify({encryptedData:p,iv:A})}),console.log("Credentials encrypted and saved to the vault."),chrome.notifications.create({type:"basic",iconUrl:"images/icon48.png",title:"Password Saved",message:`Your login for ${new URL(s.data.url).hostname} has been saved.`}),y({success:!0})}else if(s.type==="GET_CREDENTIALS_FOR_URL"){if(!b.isLoggedIn||!b.derivedKey)throw new Error("Not logged in.");const h=await Z(`${F}/passwords`),p=f=>{try{return new URL(f).origin}catch(D){return console.warn("Invalid URL encountered:",f,D),null}},A=p(s.url),K=[];for(const f of h){const D=await re(f.data,f.iv,b.derivedKey),_=JSON.parse(D);if(_.url){const m=p(_.url);A&&m&&A===m&&K.push(_)}}y({success:!0,data:K})}}catch(h){console.error(`Error in background script for message type ${s.type}:`,h),y({success:!1,error:h.message})}})(),!0))})();
